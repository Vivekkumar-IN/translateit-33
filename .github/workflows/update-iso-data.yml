
name: Update ISO Language Data

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  update-iso-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch and process ISO 639-1 data
        run: |
          mkdir -p src/data
          node -e "
          const https = require('https');
          const fs = require('fs');
          
          // Fetch ISO 639-1 data from a reliable source
          const url = 'https://raw.githubusercontent.com/haliaeetus/iso-639/master/data/iso_639-1.json';
          
          https.get(url, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const isoData = JSON.parse(data);
                const languageMap = {};
                
                // Convert to simple code: name format
                isoData.forEach(lang => {
                  if (lang.code && lang.name) {
                    languageMap[lang.code] = lang.name;
                  }
                });
                
                // Add fallback languages if not present
                const fallbacks = {
                  'en': 'English',
                  'hi': 'Hindi',
                  'es': 'Spanish',
                  'fr': 'French',
                  'de': 'German',
                  'ja': 'Japanese',
                  'zh': 'Chinese',
                  'ru': 'Russian',
                  'ar': 'Arabic'
                };
                
                Object.entries(fallbacks).forEach(([code, name]) => {
                  if (!languageMap[code]) {
                    languageMap[code] = name;
                  }
                });
                
                // Write to file
                fs.writeFileSync('src/data/iso639-1.json', JSON.stringify(languageMap, null, 2));
                console.log('ISO language data updated successfully');
              } catch (error) {
                console.error('Error processing data:', error);
                process.exit(1);
              }
            });
          }).on('error', (error) => {
            console.error('Error fetching data:', error);
            process.exit(1);
          });
          "

      - name: Commit and push if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/data/iso639-1.json
          git diff --staged --quiet || (git commit -m "Update ISO language data" && git push)
